#!/usr/bin/env bash
#
# Perform all updates

# -----------------------------------------------------------------------------
# | Errors                                                                     |
# -----------------------------------------------------------------------------

declare -r E_OSX_UPDATE_FAILURE=101
declare -r E_BREW_UPDATE_FAILURE=102
declare -r E_NPM_UPDATE_FAILURE=103
declare -r E_RUBY_UPDATE_FAILURE=104
declare -r E_PIP_UPDATE_FAILURE=105
declare -r E_PIP3_UPDATE_FAILURE=106

# -----------------------------------------------------------------------------
# | Global variables                                                           |
# -----------------------------------------------------------------------------



# -----------------------------------------------------------------------------
# | Functions                                                                  |
# -----------------------------------------------------------------------------

update_osx() {
    # TODO: detect if ~/bin or during bootstrap
    start_spinner "Updating OSX (if system restarts, run 'cd ${HOME} && ./dotfiles/script/bootstrap')"
    sudo softwareupdate -ia >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null
    status_stop_spinner "Finished updating OSX"
    exit_on_fail "OSX update failed" "${E_OSX_UPDATE_FAILURE}"
}

update_homebrew() {
    start_spinner "Updating Homebrew"
    brew update >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null \
       && brew upgrade --all >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null \
       && brew cleanup >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null
    status_stop_spinner "Finished updating Homebrew"
    exit_on_fail "Homebrew update failed" "${E_BREW_UPDATE_FAILURE}"
}

update_npm() {
    start_spinner "Updating NodeJS"
    npm install -g npm >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null \
        && npm update -g >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null
    status_stop_spinner "Finished updating NodeJS"
    exit_on_fail "NodeJS update failed" "${E_NPM_UPDATE_FAILURE}"
}

# TODO: why does ruby need sudo?
update_gems() {
    start_spinner "Updating Ruby"
    sudo gem update >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null
    status_stop_spinner "Finished updating Ruby"
    exit_on_fail "Ruby update failed" "${E_RUBY_UPDATE_FAILURE}"
}

# TODO: update other packages?
update_pip() {
    start_spinner "Updating Python 2.x"
    pip install --upgrade pip setuptools >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null
    status_stop_spinner "Finished updating Python 2.x"
    exit_on_fail "Python 2.x update failed" "${E_PIP_UPDATE_FAILURE}"
}

update_pip3() {
    start_spinner "Updating python 3.x"
    pip3 install --upgrade pip setuptools >> "${HOME}/dotfiles/dot_stderr.log" 2>&1 > /dev/null
    status_stop_spinner "Finished updating Python 3.x"
    exit_on_fail "Python 3.x update failed" "${E_PIP3_UPDATE_FAILURE}"
}

# -----------------------------------------------------------------------------
# | Main                                                                       |
# -----------------------------------------------------------------------------

main() {
    # switch path to script source
    cd "$(dirname "${BASH_SOURCE}")" \
        && source "../script/utils.sh"

    # TODO: do something when script is run from ~/bin
    if [[ "$?" -ne 0 ]]; then
        echo "Error: dotfile utils not found"
        exit 1
    fi

    # skip certain updates
    local U_OSX=0
    local U_BREW=0
    local U_NPM=0
    local U_GEM=0
    local U_PIP=0
    local U_PIP3=0

    # TODO: make more complex options
    if [[ ("$#" -ge 1) && ("$1" -eq 1) ]]; then
        U_OSX=1
    fi

    # osx
    if [[ ("$(get_os)" == "osx") && ("${U_OSX}" -eq 0) ]]; then
        update_osx
        exit_on_fail "OSX update failed"
    fi

    # brew
    if cmd_exists 'brew' && [[ "${U_BREW}" -eq 0 ]]; then
        update_homebrew
        exit_on_fail "Homebrew update failed"
    fi

    # node
    if cmd_exists 'npm' && [[ "${U_NPM}" -eq 0 ]]; then
        update_npm
        exit_on_fail "NPM update failed"
    fi

    # ruby
    if cmd_exists 'gem' && [[ "${U_GEM}" -eq 0 ]]; then
        update_gems
        exit_on_fail "gem update failed"
    fi

    # python 2.7
    if cmd_exists 'pip' && [[ "${U_PIP}" -eq 0 ]]; then
        update_pip
        exit_on_fail "pip update failed"
    fi

    # python 3
    if cmd_exists 'pip3' && [[ "${U_PIP3}" -eq 0 ]]; then
        update_pip3
        exit_on_fail "pip3 update failed"
    fi

    print_success "Finished running updates"
}

main "$1"
