#!/usr/bin/env bash
#
# Set custom icons
# Using: Tina Latif's  http://flaticns.com/

# replace_icon(icns, app):
replace_icon() {
    file="$1"
    dest="$2"
    icon=/tmp/$(basename "${file}")
    rsrc=/tmp/icon.rsrc

    # generate rsrc
    cp "${file}" "${icon}"
    if ! status_code; then
        sudo cp "${file}" "${icon}"
    fi
    sips -i "${icon}" > /dev/null
    if ! status_code; then
        sudo sips -i "${icon}" > /dev/null
    fi
    DeRez -only icns "${icon}" > "${rsrc}"
    if ! status_code; then
        sudo DeRez -only icns "${icon}" > "${rsrc}"
    fi

    # set icon
    Rez -append "${rsrc}" -o "$dest"$'/Icon\r'
    if ! status_code; then
        sudo Rez -append "${rsrc}" -o "$dest"$'/Icon\r'
    fi
    SetFile -a C "${dest}"
    if ! status_code; then
        sudo SetFile -a C "${dest}"
    fi
    SetFile -a V "$dest"$'/Icon\r'
    if ! status_code; then
        sudo SetFile -a V "$dest"$'/Icon\r'
    fi
}

# replace_app_icon(icns):
replace_app_icon() {
    icon="$1"
    name=$(basename "${icon}" .icns)
    app="/Applications/${name}.app"
    if [[ -d "${app}" ]]; then
        replace_icon "${icon}" "${app}" >> "${ERROR_FILE}" 2>&1 > /dev/null
        status_no_exit "Replaced ${name} icon"
        return "$?"
    else
        return 1
    fi
}

# rename_icons(icon_dir)
rename_icons() {
    cp -R "$1/sublime text 2.icns" "$1/sublime text 3.icns"
    cp -R "$1/sublime text 2.icns" "$1/sublime text.icns"
    cp -R "$1/1password.icns" "$1/1password 5.icns"
    cp -R "$1/android.icns" "$1/android file transfer.icns"
    cp -R "$1/transmission-1.icns" "$1/transmission.icns"
    cp -R "$1/github.icns" "$1/github desktop.icns"
    cp -R "$1/unarchiver.icns" "$1/the unarchiver.icns"
    cp -R "$1/colors.icns" "$1/couleurs.icns"
}

main() {
    # switch path to script source
    cd "$(dirname "${BASH_SOURCE}")"
    if [[ "$?" -ne 0 ]]; then
        echo "Error: Could not find script"
        exit 1
    fi

    source "../script/utils.sh" || source "${DOTS}/script/utils.sh"
    if [[ "$?" -ne 0 ]]; then
        echo "Error: dotfile utils not found"
        exit 1
    fi

    declare -r ICON_URL='https://github.com/tinalatif/flat.icns/archive/master.zip'
    declare -r ICON_ZIP='/tmp/tinalatif-zip'
    declare -r ICON_DIR='/tmp/tinalatif-icns'

    request_sudo

    curl -LsS -o "${ICON_ZIP}" "${ICON_URL}" >> "${ERROR_FILE}" 2>&1 > /dev/null || return 1
    unzip -qq -o -j "${ICON_ZIP}" -d "${ICON_DIR}" >> "${ERROR_FILE}" 2>&1 > /dev/null || return 1

    # some apps icons arent named the same as the app itself
    rename_icons "${ICON_DIR}"

    print_info "Updating app icons"

    # replace icons
    for file in ${ICON_DIR}/*.icns; do
        replace_app_icon "${file}"
    done

    # clean up
    rm -rf $ICON_ZIP
    rm -rf $ICON_DIR
    rm -rf /tmp/*icns
    rm -rf /tmp/*rscs

    print_success "Finished updating app icons"

    killall 'Dock'
}

main
